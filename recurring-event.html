
<link rel='import' href='../polymer/polymer.html'/>

<dom-module is='recurring-event'>

	<template></template>

	<script>

		var RecurringEvent = RecurringEvent ? RecurringEvent : {};

		RecurringEvent.RecurringEventBehavior = {
			
			properties: {

				event: {
					type: String
				},

				eventDetail: {
					type: Object
				},

				eventOptions: {
					type: Object
				},

				fireRate: {
					type: Number
				},

				jobName: {
					type: String
				},

				paused: {
					type: Boolean,
					value: false,
					observer: "_onTogglePaused"
				},

				validSetup: {
					type: Boolean,
					computed: "_allExist(event, fireRate, jobName)",
					observer: "_onValidityChanged",
					readOnly: true,
					notify: true
				}

			},

			ready: function() {
				if (!this.jobName) this.jobName = this._generateJobName();
			},

			recurringFire: function(overridePause) {
				if (!this.validSetup) return;

				if (this.paused && !overridePause) return;
				if (this.isDebouncerActive(this.jobName)) return;

				this.fire(this.event, this.eventDetail, this.eventOptions);

				this.debounce(this.jobName, this.recurringFire, this.fireRate);
			},

			forceFire: function() {
				this.cancelDebouncer(this.jobName);
				this.recurringFire(true);
			},

			_onTogglePaused: function(isPaused) {
				if (!isPaused) this.async(this.recurringFire);
			},

			_onValidityChanged: function(isValidSetup) {
				if (isValidSetup) this.async(this.recurringFire);
			},

			_generateJobName: function() {
				var uid = RecurringEvent.lastUID ? (RecurringEvent.lastUID + 1) : 1;
				RecurringEvent.lastUID = uid;

				return "recurring-event-job-_autogenerated-"+uid;
			},

			_allExist: function() {
				for (var i = 0; i < arguments.length; i++) {
					if (typeof arguments[i] === "undefined") return false;
				}

				return true;
			}

		};

		Polymer({

			is: "recurring-event",

			behaviors: [RecurringEvent.RecurringEventBehavior]

		});

	</script>

</dom-module>
